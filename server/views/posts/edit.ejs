<div class="row">
  <!-- Cột trái 80% -->
  <div class="col-lg-9">
    <!-- Tiêu đề & slug -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Tiêu đề bài viết</label>
          <input type="text" class="form-control" name="title" value="<%= item ? (item.title||'') : '' %>" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Đường dẫn tĩnh</label>
          <input type="text" class="form-control" name="slug" value="<%= item ? (item.slug||'') : '' %>">
          <small class="text-muted">Tự sinh từ tiêu đề nếu để trống.</small>
        </div>
      </div>
    </div>

    <!-- Nội dung -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label">Nội dung</label>
        <div data-quill-editor style="min-height:280px;"></div>
        <textarea name="content_html" hidden><%= item ? (item.content_html || '') : '' %></textarea>
      </div>
    </div>

    <!-- SEO (placeholder) -->
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="mb-3">SEO</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Meta title</label>
            <input type="text" class="form-control" name="seo_title" value="">
          </div>
          <div class="col-md-6">
            <label class="form-label">Meta description</label>
            <input type="text" class="form-control" name="seo_description" value="">
          </div>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <button class="btn btn-primary">Lưu</button>
      <a href="/admin/posts" class="btn btn-outline-secondary">Hủy</a>
    </div>
  </div>

  <!-- Cột phải 20% -->
  <div class="col-lg-3">
    <!-- Trạng thái + Lịch đăng -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label">Trạng thái</label>
        <select class="form-select" name="status" id="statusSelect">
          <% const st = item ? item.status : 'draft'; %>
          <option value="draft"     <%= st==='draft' ? 'selected' : '' %>>Nháp</option>
          <option value="pending"   <%= st==='pending' ? 'selected' : '' %>>Chờ duyệt</option>
          <option value="scheduled" <%= st==='scheduled' ? 'selected' : '' %>>Lên lịch</option>
          <option value="published" <%= st==='published' ? 'selected' : '' %>>Xuất bản</option>
          <option value="private"   <%= st==='private' ? 'selected' : '' %>>Riêng tư</option>
        </select>

        <div id="scheduleWrap" class="mt-3" style="<%= st==='scheduled' ? '' : 'display:none' %>">
          <label class="form-label">Thời điểm đăng (dd/MM/yyyy HH:mm)</label>
          <input type="text" class="form-control" name="scheduled_at_local"
                 value="<%= scheduled_at_local || '' %>" placeholder="31/10/2025 14:30">
          <small class="text-muted">Chỉ áp dụng khi trạng thái là “Lên lịch”.</small>
        </div>

        <div class="mt-3">
          <label class="form-label">Ngày tạo</label>
          <input type="text" class="form-control" value="<%= created_at_local || '' %>" readonly>
        </div>
      </div>
    </div>

    <!-- Ảnh đại diện -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label">Ảnh đại diện</label>
        <div class="d-flex gap-2 mb-2">
          <button type="button" class="btn btn-sm btn-outline-primary" data-upload-featured>Tải ảnh</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Sắp có">Chọn ảnh</button>
        </div>
        <input type="hidden" name="featured_url" value="<%= item ? (item.featured_url||'') : '' %>">
        <div id="featuredPreview">
          <% if (item && item.featured_url){ %>
            <img src="<%= item.featured_url %>" class="img-fluid border">
          <% } %>
        </div>
      </div>
    </div>

    <!-- Danh mục -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label d-flex align-items-center">
          Danh mục
          <span class="ms-2" data-bs-toggle="tooltip" title="Chọn nhiều danh mục (checkbox). Chọn 1 danh mục chính (chấm tròn) trong số danh mục đã chọn.">?</span>
        </label>

        <div class="border rounded p-2" style="max-height:260px; overflow:auto;">
          <% (categories||[]).forEach(c => {
               const checked = (selectedCategoryIds||[]).map(String).includes(String(c.id));
               const primary = String(primaryCategoryId||'') === String(c.id);
          %>
            <div class="d-flex align-items-center py-1">
              <div style="width:<%= c.depth*16 %>px"></div>
              <input class="form-check-input me-2" type="checkbox" name="selected_categories" value="<%= c.id %>" <%= checked ? 'checked' : '' %> >
              <label class="form-check-label flex-grow-1"><%= c.name %></label>
              <input class="form-check-input ms-2" type="radio" name="primary_category_id" value="<%= c.id %>" <%= primary ? 'checked' : '' %> title="Danh mục chính">
            </div>
          <% }) %>
        </div>
        <small class="text-muted">Nếu không chọn danh mục chính, hệ thống sẽ lấy danh mục chọn gần nhất làm chính.</small>
      </div>
    </div>

    <!-- Thư viện ảnh (gallery) -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label">Thư viện ảnh</label>
        <div class="d-flex gap-2 mb-2">
          <button type="button" class="btn btn-sm btn-outline-primary" data-upload-gallery>Tải ảnh</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Sắp có">Chọn ảnh</button>
        </div>
        <div id="galleryPreview" class="d-flex flex-wrap gap-2"></div>
        <input type="hidden" name="gallery_json" value="">
      </div>
    </div>
  </div>
</div>

<script>
  // Ẩn/hiện lịch theo trạng thái
  (function(){
    var sel = document.getElementById('statusSelect');
    var wrap = document.getElementById('scheduleWrap');
    if (sel && wrap){
      sel.addEventListener('change', function(){
        wrap.style.display = (this.value === 'scheduled') ? '' : 'none';
      });
    }
  })();
</script>
