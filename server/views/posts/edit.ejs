<% if (error) { %>
  <div class="alert alert-danger"><%= error %></div>
<% } %>

<form method="post" action="<%= (mode==='edit' && item) ? ('/admin/posts/'+item.id+'/edit') : '/admin/posts/new' %>">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

  <div class="row">
    <!-- LEFT -->
    <div class="col-lg-9">
      <!-- Title -->
      <div class="mb-3">
        <label class="form-label">Tiêu đề bài viết</label>
        <input type="text" class="form-control" name="title" id="title"
               value="<%= (item && item.title) || '' %>" placeholder="Nhập tiêu đề...">
      </div>

      <!-- Slug -->
      <div class="mb-3">
        <label class="form-label">Đường dẫn tĩnh</label>
        <input type="text" class="form-control" name="slug" id="slug"
               value="<%= (item && item.slug) || '' %>" placeholder="tu-dong-tao-theo-tieu-de">
      </div>

      <!-- Content -->
		<div class="mb-3">
		  <label class="form-label">Nội dung</label>
		  <div class="form-control p-0" style="min-height:240px;" data-quill-editor></div>
		  <textarea name="content_html" hidden><%= (item && item.content_html) ? item.content_html : '' %></textarea>
		</div>


      <!-- SEO placeholder -->
	  <%- include('../partials/seo_panel', { seo, seoDefaults, csrfToken }) %>
	
      <!-- Actions -->
      <div class="mb-5">
        <button class="btn btn-primary">Lưu</button>
        <a class="btn btn-outline-secondary" href="/admin/posts">Huỷ</a>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-3">
      <div class="card mb-3">
        <div class="card-header"><strong>Cài đặt bài viết</strong></div>
        <div class="card-body">
          <!-- Status -->
          <div class="mb-3">
            <label class="form-label">Trạng thái bài viết</label>
            <select class="form-select" name="status" id="status">
              <% const st = (item && item.status) || 'draft'; %>
              <option value="draft" <%= st==='draft'?'selected':'' %>>Bản nháp</option>
              <option value="pending" <%= st==='pending'?'selected':'' %>>Chờ duyệt</option>
              <option value="scheduled" <%= st==='scheduled'?'selected':'' %>>Lên lịch</option>
              <option value="published" <%= st==='published'?'selected':'' %>>Xuất bản</option>
            </select>
          </div>

          <!-- Created at -->
          <div class="mb-3">
            <label class="form-label">Ngày tạo</label>
            <input type="datetime-local" class="form-control" name="created_at_local"
                   value="<%= created_at_local || '' %>">
            <div class="form-text">Định dạng: DD/MM/YYYY HH:mm (theo Cài đặt múi giờ)</div>
          </div>

          <!-- Schedule at -->
          <div class="mb-3" id="schedule-block" style="<%= ((item && item.status)==='scheduled' || (typeof scheduled_at_local!=='undefined' && scheduled_at_local))?'':'display:none' %>">
            <label class="form-label">Lên lịch đăng</label>
            <input type="datetime-local" class="form-control" name="scheduled_at_local"
                   value="<%= scheduled_at_local || '' %>">
            <div class="form-text">Chỉ áp dụng khi trạng thái là “Lên lịch”. Thời điểm phải ở tương lai.</div>
          </div>

          <!-- Featured image -->
         <div class="mb-3">
		  <label class="form-label">Ảnh đại diện</label>
		  <div class="d-flex gap-2 align-items-start">
			<div data-featured-preview class="min-w-120">
			  <% if (item && item.featured_url) { %>
				<div class="position-relative d-inline-block">
				  <img src="<%= item.featured_url %>" class="img-thumbnail" style="max-width:120px">
				  <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" data-remove="featured">&times;</button>
				</div>
			  <% } else { %>
				<div class="text-muted small">Chưa chọn ảnh</div>
			  <% } %>
			</div>
			<div class="d-flex flex-column gap-2">
			  <button type="button" class="btn btn-outline-primary btn-sm" data-featured-upload>Tải ảnh</button>
			  <button type="button" class="btn btn-outline-secondary btn-sm" data-featured-choose>Chọn ảnh</button>
			</div>
		  </div>
		  <input type="hidden" name="featured_url" value="<%= (item && item.featured_url) ? item.featured_url : '' %>">
		</div>

          <!-- Categories -->
          <div class="mb-3">
            <label class="form-label">
              Danh mục
              <span class="ms-1 text-muted" data-bs-toggle="tooltip" title="Chọn nhiều danh mục (checkbox). Chọn 1 danh mục chính (chấm tròn) trong số danh mục đã chọn.">?</span>
            </label>

            <div class="border rounded p-2" style="max-height:260px; overflow:auto;">
              <% (categories||[]).forEach(c => {
                   const checked = (selectedCategoryIds || []).includes(String(c.id));
                   const primary = (String(primaryCategoryId||'') === String(c.id));
              %>
                <label class="list-group-item d-flex align-items-center justify-content-between py-2 px-0 border-0">
                  <span class="d-flex align-items-center">
                    <input class="form-check-input me-2 cat-check" type="checkbox"
                           name="category_ids[]" value="<%= c.id %>" <%= checked?'checked':'' %>>
                    <span class="text-truncate"><%= c.indented_name %></span>
                  </span>
                  <span class="ms-2">
                    <input class="form-check-input cat-radio" type="radio"
                           name="primary_category_id" value="<%= c.id %>" <%= primary?'checked':'' %> <%= checked?'':'disabled' %>>
                  </span>
                </label>
              <% }) %>
            </div>
          </div>

          <!-- Gallery -->
			<div class="mb-3">
			  <label class="form-label">Thư viện ảnh</label>
			  <div class="mb-2 d-flex gap-2">
				<button type="button" class="btn btn-outline-primary btn-sm" data-gallery-upload>Tải ảnh</button>
				<button type="button" class="btn btn-outline-secondary btn-sm" data-gallery-choose>Chọn ảnh</button>
			  </div>

			  <div class="d-flex flex-wrap gap-2" data-gallery-list>
				<% (gallery || []).forEach(function(g){ %>
				  <div class="position-relative d-inline-block" data-item data-url="<%= g.url %>">
					<img src="<%= g.url %>" class="img-thumbnail" style="height:70px">
					<button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" data-remove="gallery">&times;</button>
					<input type="hidden" name="gallery_urls[]" value="<%= g.url %>">
				  </div>
				<% }); %>
			  </div>
			</div>
          </div>
        </div>
      </div>
    </div> <!-- /RIGHT -->
  </div>
</form>
