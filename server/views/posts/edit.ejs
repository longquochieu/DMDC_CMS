<%- include('../partials/flash') %>
<form method="post" action="<%= item ? `/admin/posts/${item.id}/edit` : '/admin/posts/new' %>">
	<input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <div class="row">
    <div class="col-lg-9">
      <div class="card mb-3">
        <div class="card-body">
          <div class="form-group">
            <label>Tiêu đề</label>
            <input type="text" class="form-control" name="title" data-field="title" value="<%= item?item.title||'':'' %>" required>
          </div>
          <div class="form-group">
            <label>Slug</label>
            <input type="text" class="form-control" name="slug" data-field="slug" value="<%= item?item.slug||'':'' %>" required>
            <small class="text-muted">Slug tự sinh theo tiêu đề, có thể chỉnh.</small>
          </div>
          <div class="form-group">
            <label>Mô tả ngắn (Excerpt)</label>
            <textarea class="form-control" name="excerpt" rows="2"><%= item?item.excerpt||'' : '' %></textarea>
          </div>
          <div class="form-group">
            <label>Nội dung</label>
            <div data-quill-editor></div>
            <textarea name="content_html" class="d-none"><%= item?item.content_html||'' : '' %></textarea>
          </div>
          <button class="btn btn-primary">Xuất bản</button>
        </div>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="card mb-3">
        <div class="card-header"><strong>Trạng thái & Thời gian</strong></div>
        <div class="card-body">
          <div class="form-group">
            <label>Status</label>
            <select class="form-control" name="status">
              <% ['draft','pending','published'].forEach(s=>{ %>
                <option value="<%= s %>" <%= item&&item.status===s?'selected':'' %>><%= s %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Display date</label>
            <input type="datetime-local" class="form-control" name="display_date" value="<%= item && item.display_date ? item.display_date_local : '' %>">
          </div>
          <div class="form-group">
            <label>Scheduled At</label>
            <input type="datetime-local" class="form-control" name="scheduled_at" value="<%= item && item.scheduled_at ? item.scheduled_at_local : '' %>">
          </div>
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-header"><strong>Danh mục</strong></div>
        <div class="card-body">
          <% function renderCat(nodes){ %>
            <% (nodes||[]).forEach(function(n){ %>
              <div class="ml-<%= n.level||0 %>">
                <label class="d-block">
                  <input type="checkbox" name="category_ids" value="<%= n.id %>" <%= (selectedCategoryIds||[]).includes(n.id)?'checked':'' %>>
                  <%= n.title %>
                  <span class="text-muted">/<%= n.slug %></span>
                </label>
                <label class="small ml-3">
                  <input type="radio" name="primary_category_id" value="<%= n.id %>" <%= primaryCategoryId===n.id?'checked':'' %>> Primary
                </label>
              </div>
              <% if (n.children && n.children.length){ %>
                <% renderCat(n.children); %>
              <% } %>
            <% }) %>
          <% } %>
          <%- (function(){ renderCat(categoriesTree||[]); return '' })() %>
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-header"><strong>Tags (≤10)</strong></div>
        <div class="card-body">
          <input type="text" class="form-control" id="tags-input" placeholder="Nhập tag, Enter để thêm">
          <div id="tags-chips" class="mt-2"></div>
          <input type="hidden" name="tags_csv" id="tags-csv">
          <small class="text-muted">Tối đa 10 thẻ; Enter để thêm, × để xoá.</small>
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-header"><strong>Ảnh đại diện</strong></div>
        <div class="card-body">
          <% if (item && item.featured_url){ %>
            <img src="<%= item.featured_url %>" style="width:100%;height:auto;max-height:160px;object-fit:cover" class="mb-2">
          <% } %>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-pick-featured>Chọn từ Media</button>
          <input type="hidden" name="featured_media_id" value="<%= item?item.featured_media_id||'':'' %>">
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-header"><strong>Gallery ảnh</strong></div>
        <div class="card-body">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-pick-gallery>Chọn nhiều ảnh</button>
          <div id="gallery-preview" class="mt-2 d-flex flex-wrap"></div>
          <% (galleryMedia||[]).forEach(function(m){ %>
            <input type="hidden" name="gallery_media_ids" value="<%= m.id %>">
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</form>
<script src="/js/slug.js"></script>
<script>
(function(){
  var input = document.getElementById('tags-input');
  var chips = document.getElementById('tags-chips');
  var hidden = document.getElementById('tags-csv');
  function syncHidden(){
    var vals = Array.from(chips.querySelectorAll('.chip')).map(x=>x.getAttribute('data-v'));
    hidden.value = vals.join(',');
  }
  function addChip(v){
    v = (v||'').trim(); if(!v) return;
    var cur = Array.from(chips.querySelectorAll('.chip')).map(x=>x.getAttribute('data-v').toLowerCase());
    if (cur.includes(v.toLowerCase())) return;
    if (cur.length >= 10) { alert('Tối đa 10 tag'); return; }
    var d = document.createElement('span'); d.className='badge badge-primary mr-1 chip'; d.setAttribute('data-v', v); d.textContent = v;
    var rm = document.createElement('a'); rm.href='#'; rm.innerHTML='&times;'; rm.className='text-white ml-1'; rm.onclick=function(e){ e.preventDefault(); d.remove(); syncHidden(); };
    d.appendChild(rm); chips.appendChild(d); syncHidden();
  }
  input && (input.onkeydown=function(e){ if(e.key==='Enter'){ e.preventDefault(); addChip(input.value); input.value=''; }});
  <% if (typeof selectedTags !== 'undefined') { %>
    <% (selectedTags||[]).forEach(function(t){ %> addChip("<%= t %>"); <% }) %>
  <% } %>
  function pickOne(cb){
    fetch('/admin/media/list', { headers: { 'Accept':'application/json' } })
      .then(r=>r.json()).then(json=>{
        var s = prompt('Chọn ảnh đại diện (nhập chỉ số):\n'+json.items.map((m,i)=> i+': '+m.original_filename).join('\n'));
        if (s===null) return;
        var i = parseInt(s,10); if (isNaN(i)||i<0||i>=json.items.length) return alert('Lựa chọn không hợp lệ');
        cb(json.items[i]);
      }).catch(e=>alert('Không tải được media: '+e.message));
  }
  document.querySelector('[data-pick-featured]')?.addEventListener('click', function(){
    pickOne(function(m){
      document.querySelector('input[name=featured_media_id]').value = m.id;
      var prev = document.createElement('img'); prev.src = m.url; prev.style='width:100%;max-height:160px;object-fit:cover';
      var box = document.querySelector('[data-pick-featured]').closest('.card-body');
      var old = box.querySelector('img'); if (old) old.remove();
      box.insertBefore(prev, box.firstChild);
    });
  });
  document.querySelector('[data-pick-gallery]')?.addEventListener('click', function(){
    fetch('/admin/media/list', { headers: { 'Accept':'application/json' } })
      .then(r=>r.json()).then(json=>{
        var s = prompt('Nhập danh sách chỉ số, ví dụ: 0,2,3'); if (s===null) return;
        var idx = s.split(',').map(x=>parseInt(x.trim(),10)).filter(x=>!isNaN(x));
        var chosen = idx.map(i=>json.items[i]).filter(Boolean);
        var wrap = document.getElementById('gallery-preview');
        wrap.innerHTML='';
        document.querySelectorAll('input[name=gallery_media_ids]').forEach(x=>x.remove());
        chosen.forEach(m=>{
          var img = document.createElement('img'); img.src=m.url; img.style='width:60px;height:60px;object-fit:cover;margin:2px'; wrap.appendChild(img);
          var h = document.createElement('input'); h.type='hidden'; h.name='gallery_media_ids'; h.value=m.id; document.forms[0].appendChild(h);
        });
      }).catch(e=>alert('Không tải được media: '+e.message));
  });
})();
</script>
