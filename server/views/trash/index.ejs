<% const okMsg  = typeof ok  !== 'undefined' ? ok  : ''; %>
<% const errMsg = typeof err !== 'undefined' ? err : ''; %>
<% const currentTab = tab || 'posts'; %>
<%
  const tabToEntity = { pages:'page', posts:'post', categories:'category', tags:'tag', media:'media' };
  const entity = tabToEntity[currentTab] || 'post';
%>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Thùng rác</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm <%= (currentTab==='pages'?'active':'') %>" href="/admin/trash?tab=pages">Trang đã xoá</a>
      <a class="btn btn-outline-secondary btn-sm <%= (currentTab==='posts'?'active':'') %>" href="/admin/trash?tab=posts">Bài viết đã xoá</a>
      <a class="btn btn-outline-secondary btn-sm <%= (currentTab==='categories'?'active':'') %>" href="/admin/trash?tab=categories">Danh mục đã xoá</a>
      <a class="btn btn-outline-secondary btn-sm <%= (currentTab==='tags'?'active':'') %>" href="/admin/trash?tab=tags">Thẻ đã xoá</a>
      <a class="btn btn-outline-secondary btn-sm <%= (currentTab==='media'?'active':'') %>" href="/admin/trash?tab=media">Media đã xoá</a>

      <form method="post" action="/admin/trash/empty?tab=<%= currentTab %>" onsubmit="return confirm('Xoá vĩnh viễn TẤT CẢ mục trong tab hiện tại?');">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button class="btn btn-danger btn-sm">Xoá toàn bộ</button>
      </form>
    </div>
  </div>

  <% if (okMsg) { %><div class="alert alert-success">Thao tác thành công: <%= okMsg %></div><% } %>
  <% if (errMsg) { %><div class="alert alert-danger">Lỗi: <%= errMsg %></div><% } %>

  <div class="card">
    <div class="card-body p-0">
      <form method="post" action="/admin/trash/bulk?tab=<%= currentTab %>">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div class="d-flex gap-2 p-3 border-bottom align-items-center">
          <select name="action" class="form-select form-select-sm" style="width:auto;">
            <option value="">— Bulk actions —</option>
            <option value="restore">Khôi phục</option>
            <option value="destroy">Xoá hẳn</option>
          </select>
          <button class="btn btn-sm btn-primary">Áp dụng</button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:40px;"><input type="checkbox" onclick="document.querySelectorAll('input[name=\'ids[]\']').forEach(c=>c.checked=this.checked)"></th>
                <th style="width:80px;">ID</th>
                <th>Tiêu đề</th>
                <th>Slug / URL</th>
                <th>Người xoá</th>
                <th>Thời gian xoá (log)</th>
                <th>Đã xoá lúc (record)</th>
                <th style="width:180px;" class="text-end">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <% if (!rows || !rows.length) { %>
                <tr><td colspan="8" class="text-center text-muted py-4">Chưa có mục nào trong thùng rác.</td></tr>
              <% } else { %>
                <% rows.forEach(r => { %>
                  <tr>
                    <td><input type="checkbox" name="ids[]" value="<%= r.id %>"></td>
                    <td><code><%= r.id %></code></td>
                    <td><%= r.title || '(Không tiêu đề)' %></td>
                    <td><%= r.slug || r.url || '' %></td>
                    <td><%= r.deleter_username || '—' %></td>
                    <td><%= r.deleted_time || '—' %></td>
                    <td><%= r.deleted_at  || '—' %></td>
                    <td class="text-end">
                      <form action="/admin/trash/<%= entity %>/<%= r.id %>/edit" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-primary">Sửa</button>
                      </form>
                      <form action="/admin/trash/<%= entity %>/<%= r.id %>/restore" method="post" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-success">Khôi phục</button>
                      </form>
                      <form action="/admin/trash/<%= entity %>/<%= r.id %>/destroy" method="post" class="d-inline"
                            onsubmit="return confirm('Xoá vĩnh viễn mục này? Hành động không thể hoàn tác!')">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-danger">Xoá hẳn</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </form>
    </div>
  </div>
</div>
