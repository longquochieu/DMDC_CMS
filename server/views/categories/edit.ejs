<!-- server/views/categories/edit.ejs -->
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0"><%= pageTitle %></h1>
    <div>
      <a href="/admin/categories/table" class="btn btn-secondary btn-sm">Quay lại danh sách</a>
    </div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <form method="post" action="<%= item ? ('/admin/categories/' + item.id + '/edit') : '/admin/categories/new' %>">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <div class="row">
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-header"><strong>Thông tin chính</strong></div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Tên danh mục</label>
              <!-- thêm id="title" để SEO tabs auto bind -->
              <input id="title" type="text" class="form-control" name="name" value="<%= item ? (item.name || '') : '' %>" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Đường dẫn tĩnh (slug)</label>
              <input type="text" class="form-control" name="slug" placeholder="tudong-tao-tu-ten-neu-bo-trong" value="<%= item ? (item.slug || '') : '' %>">
              <div class="form-text">Nếu để trống, hệ thống sẽ tự tạo từ tên danh mục.</div>
            </div>
          </div>
        </div>

        <!-- ====== NỘI DUNG (QUILL) – thêm mới, không chạm phần khác ====== -->
        <div class="card mb-3">
          <div class="card-header"><strong>Nội dung</strong></div>
          <div class="card-body">
            <!-- Hidden field để submit nội dung -->
            <textarea id="category_content_html" name="content_html" class="d-none"><%- (item && item.content_html) ? item.content_html : '' %></textarea>

            <!-- Vùng Quill -->
            <div id="category_quill"
                 class="quill-editor"
                 data-target="#category_content_html"
                 data-placeholder="Nhập nội dung mô tả cho danh mục...">
            </div>

            <div class="form-text mt-2">
              Trình soạn thảo hỗ trợ ảnh, bảng, nhúng YouTube... Nội dung dùng cho mô tả danh mục ở frontend và SEO.
            </div>
          </div>
        </div>
        <!-- ====== /NỘI DUNG (QUILL) ====== -->
		<!-- SEO (để nguyên như bạn đang dùng) -->
		<%- include('../partials/seo-tabs', { seo, seoDefaults, titleInputSelector: '#title', quillVar: 'quill' }) %>
      </div><!-- col-md-8 -->

      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header"><strong>Cài đặt</strong></div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Danh mục cha</label>
              <select class="form-select" name="parent_id">
                <option value="">(Không có)</option>
                <% (parents||[]).forEach(p => { %>
                  <option value="<%= p.id %>" <%= (String(item ? (item.parent_id||'') : '') === String(p.id)) ? 'selected' : '' %>><%= p.name %></option>
                <% }) %>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Thứ tự</label>
              <input type="number" class="form-control" name="order_index" value="<%= (item && Number.isFinite(Number(item.order_index))) ? item.order_index : '' %>" placeholder="Tự tăng nếu để trống">
            </div>

            <div class="d-grid">
              <button class="btn btn-primary">Lưu</button>
            </div>
          </div>
        </div>
      </div><!-- col-md-4 -->
    </div><!-- row -->
  </form>
</div>

<style>
  /* đảm bảo vùng editor có chiều cao nhìn thấy */
  #category_quill { min-height: 260px; }
  #category_quill .ql-editor { min-height: 220px; }
</style>

<script>
(function () {
  // Tránh khởi tạo 2 lần (nếu /public/editor.js cũng init .quill-editor)
  function alreadyInitialized(el) {
    return !!el.querySelector('.ql-container');
  }

  function setInitialContent(quill, textarea) {
    try {
      const html = textarea.value || '';
      // đưa HTML vào Quill
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      quill.root.innerHTML = tmp.innerHTML; // giữ nguyên html hiện có
    } catch (e) { /* noop */ }
  }

  function bindSync(quill, textarea, form) {
    function sync() {
      textarea.value = quill.root.innerHTML;
    }
    quill.on('text-change', sync);
    if (form) form.addEventListener('submit', sync);
  }

  function ensureQuillLoaded(cb) {
    if (window.Quill) return cb();
    // nạp CSS + JS khi thiếu
    const cssHref = "https://cdn.quilljs.com/1.3.7/quill.snow.css";
    const jsSrc  = "https://cdn.quilljs.com/1.3.7/quill.min.js";

    if (!document.querySelector('link[data-quill]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = cssHref;
      link.setAttribute('data-quill', '1');
      document.head.appendChild(link);
    }
    const script = document.createElement('script');
    script.src = jsSrc;
    script.onload = cb;
    document.body.appendChild(script);
  }

  function initCategoryQuill() {
    const el = document.getElementById('category_quill');
    const ta = document.getElementById('category_content_html');
    if (!el || !ta) return;
    if (alreadyInitialized(el)) return; // đã có /public/editor.js init

    const quill = new Quill(el, {
      theme: 'snow',
      placeholder: el.getAttribute('data-placeholder') || '',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'align': [] }],
          ['link', 'image', 'video'],
          ['blockquote', 'code-block'],
          [{ 'color': [] }, { 'background': [] }],
          ['clean']
        ]
      }
    });

    setInitialContent(quill, ta);
    bindSync(quill, ta, el.closest('form'));
  }

  // Khởi tạo sau khi DOM sẵn sàng, có fallback nạp Quill nếu thiếu
  document.addEventListener('DOMContentLoaded', function () {
    ensureQuillLoaded(initCategoryQuill);
  });
})();
</script>
