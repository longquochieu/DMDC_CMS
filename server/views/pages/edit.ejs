<% /* server/views/pages/edit.ejs */ %>
<%- include('../partials/flash') %>
<meta name="csrf-token" content="<%= csrfToken %>">

<div class="row">
  <!-- Trái 80% -->
  <div class="col-lg-9">
    <form action="<%= item ? ('/admin/pages/' + item.id + '/edit') : '/admin/pages/new' %>" method="post" id="page-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <input type="hidden" name="order_index" value="<%= item ? (item.order_index || 0) : 0 %>">
      <input type="hidden" name="featured_media_id" id="featured_media_id" value="<%= item ? (item.featured_media_id || '') : '' %>">

      <!-- Tiêu đề & Slug -->
      <div class="card mb-3">
        <div class="card-header"><strong>Thông tin cơ bản</strong></div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Tiêu đề trang</label>
            <input type="text" class="form-control" name="title" id="title"
                   value="<%= item ? (item.title || '') : '' %>" placeholder="Nhập tiêu đề trang…"
                   required>
          </div>
          <div class="mb-3">
            <label class="form-label">Slug</label>
            <div class="input-group">
              <input type="text" class="form-control" name="slug" id="slug"
                     value="<%= item ? (item.slug || '') : '' %>" placeholder="vd: gioi-thieu">
              <button type="button" class="btn btn-outline-secondary" id="btn-genslug">Tạo từ tiêu đề</button>
            </div>
            <div class="form-text">Slug sẽ dùng để tạo đường dẫn đầy đủ (full_path).</div>
          </div>
        </div>
      </div>

      <!-- Nội dung (Quill) -->
      <div class="card mb-3">
        <div class="card-header"><strong>Nội dung</strong></div>
        <div class="card-body">
          <!-- Chỉ một editor duy nhất -->
          <div id="page-editor" style="min-height:300px"></div>
          <textarea name="content_html" id="content_html" class="d-none"><%- item ? (item.content_html || '') : '' %></textarea>
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-insert-media>Chèn ảnh vào nội dung</button>
          </div>
        </div>
      </div>

      <!-- SEO -->
      <%- include('../partials/seo-tabs', { seo, seoDefaults, titleInputSelector: '#title', quillVar: 'quill' }) %>

      <!-- Nút Lưu / Huỷ -->
      <div class="d-flex gap-2 mb-4">
        <button class="btn btn-primary">Lưu</button>
        <a href="/admin/pages" class="btn btn-secondary">Huỷ</a>
      </div>
    </form>
  </div>

  <!-- Phải 20%: Cài đặt trang -->
  <div class="col-lg-3">
    <div class="card mb-3">
      <div class="card-header"><strong>Cài đặt trang</strong></div>
      <div class="card-body">
        <!-- Trạng thái -->
        <div class="mb-3">
          <label class="form-label">Trạng thái</label>
          <select class="form-select" name="status">
            <option value="draft" <%= item && item.status==='draft' ? 'selected' : '' %>>Nháp</option>
            <option value="published" <%= item && item.status==='published' ? 'selected' : '' %>>Xuất bản</option>
          </select>
        </div>

        <!-- Ảnh đại diện -->
        <div class="mb-3">
          <label class="form-label">Ảnh đại diện</label>
          <div id="featured-preview" class="mb-2">
            <% if (item && item.featured_media_url) { %>
              <img src="<%= item.featured_media_url %>" class="img-fluid border">
            <% } %>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-pick-featured">Chọn ảnh</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-upload-featured">Tải ảnh</button>
          </div>
        </div>

        <!-- Thuộc tính trang -->
        <div class="mb-3">
          <label class="form-label">Trang cha</label>
          <select class="form-select" name="parent_id">
            <option value="">(Không có)</option>
            <% (parents||[]).forEach(p => { %>
              <option value="<%= p.id %>" <%= item && String(item.parent_id)===String(p.id)?'selected':'' %>><%= p.title || ('#'+p.id) %></option>
            <% }) %>
          </select>
        </div>

        <div class="mb-0">
          <label class="form-label">Mẫu trang (Template)</label>
          <select class="form-select" name="template">
            <% (templates||['default','landing','contact']).forEach(tpl => { %>
              <option value="<%= tpl %>" <%= item && item.template===tpl?'selected':'' %>><%= tpl %></option>
            <% }) %>
          </select>
        </div>
      </div>
    </div>

    <% if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
  </div>
</div>

<!-- Scripts: chỉ include MỘT lần Quill & slug; bỏ page-editor.js để tránh khởi tạo 2 lần -->
<script src="/js/slug.js"></script>
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css">

<script>
  // Bảo đảm không khởi tạo Quill trùng
  function initSingleQuill(containerSel) {
    const el = document.querySelector(containerSel);
    if (!el) return null;
    if (el.__quill) return el.__quill; // đã có

    const q = new Quill(el, {
      theme: "snow",
      modules: {
        toolbar: [
          [{ header: [false, 2, 3, 4] }],
          ["bold", "italic", "underline", "strike"],
          [{ list: "ordered" }, { list: "bullet" }],
          [{ align: [] }],
          ["blockquote", "code-block"],
          ["link", "image", "video"],
          ["clean"],
        ],
      },
      placeholder: "",
    });

    // đồng bộ textarea
    const ta = document.getElementById("content_html");
    if (ta) {
      // nếu textarea có dữ liệu sẵn -> đổ vào editor lần đầu
      if (ta.value && !q.root.innerHTML.trim()) {
        q.root.innerHTML = ta.value;
      }
      q.on("text-change", () => { ta.value = q.root.innerHTML; });
    }

    el.__quill = q;
    return q;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Auto-slug
    if (window.autoBindSlug) {
      window.autoBindSlug('#title', '#slug');
    } else {
      // fallback cho nút "Tạo từ tiêu đề"
      document.getElementById('btn-genslug')?.addEventListener('click', () => {
        if (window.toSlug) {
          const t = document.getElementById('title')?.value || '';
          document.getElementById('slug').value = window.toSlug(t);
        }
      });
    }

    // Khởi tạo đúng 1 Quill
    window.quill = initSingleQuill('#page-editor');

    // Nút chèn ảnh vào nội dung
    document.querySelector('[data-insert-media]')?.addEventListener('click', async () => {
      if (!window.quill) return;
      if (window.pickMedia) {
        const picks = await window.pickMedia({ multi: false, type: 'image' });
        if (picks && picks.length) {
          const url = picks[0].url;
          const range = window.quill.getSelection(true) || { index: window.quill.getLength(), length: 0 };
          window.quill.insertEmbed(range.index, 'image', url, 'user');
          window.quill.setSelection(range.index + 1, 0);
        }
      } else {
        const url = prompt('Dán URL ảnh:');
        if (url) {
          const range = window.quill.getSelection(true) || { index: window.quill.getLength(), length: 0 };
          window.quill.insertEmbed(range.index, 'image', url, 'user');
          window.quill.setSelection(range.index + 1, 0);
        }
      }
    });

    // Nút “Tạo từ tiêu đề” (nếu user bấm thủ công)
    document.getElementById('btn-genslug')?.addEventListener('click', () => {
      if (window.toSlug) {
        const t = document.getElementById('title')?.value || '';
        document.getElementById('slug').value = window.toSlug(t);
      }
    });
  });
</script>
